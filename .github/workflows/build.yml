name: Build X-Plane Plugin

on: [push, workflow_dispatch]

jobs:
  build:
    name: Build for ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            platform: lin_x64
            cmake_args: "-DCMAKE_BUILD_TYPE=Release"
          - os: windows-latest
            platform: win_x64
            cmake_args: "-A x64"
          - os: macos-latest
            platform: mac_x64
            # Hier definieren wir Mac Architekturen
            cmake_args: "-DCMAKE_OSX_ARCHITECTURES='x86_64;arm64'"

    steps:
    - uses: actions/checkout@v3

    # --- NEU: SDK HERUNTERLADEN (Verhindert Git-Fehler) ---
    - name: Download X-Plane SDK
      shell: bash
      run: |
        curl -L "https://developer.x-plane.com/wp-content/plugins/code-sample-generation/sample_templates/XPSDK401.zip" -o xpsdk.zip
        unzip -q xpsdk.zip
        # Wir benennen den Ordner um, damit wir den Pfad genau kennen
        mv SDK XPlaneSDK

    # Linux Dependencies installieren
    - name: Install Linux Dependencies
      if: runner.os == 'Linux'
      run: |
        sudo apt-get update
        sudo apt-get install build-essential libgl1-mesa-dev

    # CMake konfigurieren
    # WICHTIG: Wir übergeben jetzt -DXP_SDK_PATH=... an CMake!
    - name: Configure CMake
      shell: bash
      run: cmake -B build -S . -DCMAKE_BUILD_TYPE=Release -DXP_SDK_PATH=$(pwd)/XPlaneSDK ${{ matrix.cmake_args }}

    # Bauen
    - name: Build Plugin
      run: cmake --build build --config Release --parallel

    # Artefakte sortieren
    - name: Organize Artifacts
      shell: bash
      run: |
        mkdir -p output/${{ matrix.platform }}
        find build -name "*.xpl" -exec cp {} output/${{ matrix.platform }}/XP12AutoTOD.xpl \;

    # Upload
    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: XP12AutoTOD-${{ matrix.platform }}
        path: output/${{ matrix.platform }}